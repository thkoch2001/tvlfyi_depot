# This file defines the static pipeline which is uploaded in the
# Buildkite admin interface. These steps run at the beginning of each
# build and cause the dynamic pipeline generation to run.
---
steps:
  - label: ":llama:"
    command: |
      function fallback() {
        echo 'Using fallback pipeline ...'
        buildkite-agent pipeline upload ops/pipelines/fallback.yaml
        exit
      }

      nix-build -A ops.pipelines.depot -o "$DEPOT_PIPELINE_GCROOT" --show-trace || fallback

      buildkite-agent pipeline upload "$DEPOT_PIPELINE_GCROOT" || fallback
