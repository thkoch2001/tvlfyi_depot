# This file defines the static Buildkite pipeline which attempts to
# create the dynamic pipeline of all depot targets.
#
# If something fails during the creation of the pipeline, the fallback
# is executed instead which will simply report an error to Gerrit.
---
steps:
  - label: ":llama:"
    command: |
      function fallback() {
        echo 'Using fallback pipeline ...'
        buildkite-agent pipeline upload ops/pipelines/fallback.yaml
        exit
      }

      nix-build -A ops.pipelines.depot -o pipeline --show-trace || fallback
      buildkite-agent meta-data set 'failure' '0'

      cp $(readlink pipeline-2) drvmap.json
      buildkite-agent artifact upload drvmap.json

      buildkite-agent pipeline upload pipeline || fallback
