#!/usr/bin/env -S syndicate-server --config

let ?trace = dataspace
$trace
? ?any
[
  $log ! <log "nix-store" { "+++": $any } >
  ?- [ $log ! <log "nix-store" { "---": $any } > ]
]

let ?default-detail = { uri: "auto" params: {} cache: $nix-cache }
let ?test-detail = { label: "test" uri: "file:///tmp/nix-test-store" params: {} }

# <require-service <service nix-store $default-detail>>

? <service-object <service nix-store $default-detail> <ok ?default-store>>
[
  $default-store ? ?any
  [ $log ! <log "store" { line: $any }> ]

  let ?test-path = "/nix/store/90lh6zcbhqbil42yhfkx29rlnflxbz9v-cowsay-3.7.0"
  $default-store += <check-path
      $test-path
      <* $trace [ <rewrite ?result <path-check $test-path $result>> ]>
    >

  <require-service <service nix-store $test-detail>>
  ? <service-object <service nix-store $test-detail> <ok ?test-store>>
  [
    $default-store += <-copy-closure
        $test-store
        $test-path
        <* $notifier [ <rewrite ?result <notify $test-path { body: $result }>> ]>
      >
  ]

]
