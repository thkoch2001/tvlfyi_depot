#!/usr/bin/env -S syndicate-server --control --config

let ?trace = dataspace
$trace
? ?any
[
  $log ! <log "trace" { "+++": $any } >
  ?- [ $log ! <log "trace" { "---": $any } > ]
]

let ?nixStepDetail = {
    import: "<nixpkgs>"
    lookupPath: [
      "nixpkgs=/home/repo/nixpkgs/channel",
    ]
    store: "auto"
  }

# <require-service <service nix-repo $nixStepDetail>>

? <service-object <service nix-repo $nixStepDetail> <error ?reason>> [
  $log ! <log "nix-repo" { line: $reason }>
]

? <service-object <service nix-repo $nixStepDetail> <ok ?repo>>
$repo
[
  $log ! <log "nix-repo" {line: $repo }>
  ? { hello: { meta: { homepage: ?x } } }
  [
    $log ! <log "nix-repo" {line: $x }>
  ]
  ? { nim: ?nim }
  [
    ? { nim: { passthru: ?passthru } }
    [
      ? { nim: { passthru: { nim: { buildInputs: [ ?bi ] } } } }
      [
        $log ! <log "nim" { line: $nim passthru: $passthru first-build-input: $bi } >
      ]
    ]
  ]
]

let ?nixStoreDetail = { uri: "auto" params: {} }

<require-service <service nix-store $nixStoreDetail>>
? <service-object <service nix-store $nixStoreDetail> <ok ?store>>
$store
[
  <check-path "/nix/store/c2nszmh6li1r2q5z0aiajlga1rdyqwha-alacritty-0.13.2" <* $trace [<rewrite ?result <path-check $result>>]> >
]

@"Repo service instantiation."
? <require-service <service nix-repo ?detail>>
[
  <require-service <daemon nix-actor>>
  ? <service-object <daemon nix-actor> ?obj>
  [
    $log ! <log "nix-actor" { line: "nix actor service-object available" }>
    $obj <resolve <nix-repo $detail> <* $config [
      <or [
        <rewrite <accepted ?body> <service-object <service nix-repo $detail>    <ok $body>>>
        <rewrite <rejected ?body> <service-object <service nix-repo $detail> <error $body>>>
      ]>
    ]>>
  ]
]

@"Store service instantiation."
? <require-service <service nix-store ?detail>>
[
  <require-service <daemon nix-actor>>
  ? <service-object <daemon nix-actor> ?obj>
  [
    $log ! <log "nix-actor" { line: "nix actor service-object available" }>
    $obj <resolve <nix-store $detail> <* $config [
      <or [
        <rewrite <accepted ?body> <service-object <service nix-store $detail>    <ok $body>>>
        <rewrite <rejected ?body> <service-object <service nix-store $detail> <error $body>>>
      ]>
    ]>>
  ]
]

@"The authors build system creates this file."
<require-service <config-watcher "/home/emery/src/config/built/nix-actor.pr" {
  config: <* $config [
    <rewrite <built ?name ?path ?sum> <daemon $name {
      argv: [
        $path
      ]
      clearEnv: #t
      env: {
        BUILD_SUM: $sum
      }
      protocol: application/syndicate
    }>>
  ]>
}>>
